<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Page publique â€” QRLocal</title>
<link rel="manifest" href="manifest.json"><meta name="theme-color" content="#ffffff">
<style>
:root{--green:#0f6;--fg:#111;--muted:#666}
body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;color:var(--fg);background:#fff}
.wrap{max-width:820px;margin:0 auto;padding:16px}
.hero{display:flex;gap:16px;align-items:center}
.pic{width:88px;height:88px;border-radius:16px;object-fit:cover;border:1px solid #eee}
h1{margin:0 0 6px;font-size:28px}.tag{color:var(--muted);margin:0 0 6px}
.btns{display:flex;flex-wrap:wrap;gap:10px;margin:12px 0}
a.btn{display:inline-block;padding:10px 14px;border-radius:12px;text-decoration:none;border:1px solid #111;color:#111;font-weight:700}
a.btn.primary{background:var(--fg);color:#fff;border-color:var(--fg)}
.card{background:#fff;border:1px solid #eee;border-radius:14px;padding:14px;margin:12px 0;box-shadow:0 6px 20px rgba(0,0,0,.03)}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
.notice{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#111;color:#fff;padding:10px 14px;border-radius:12px;opacity:0;transition:opacity .4s}
.notice.show{opacity:1}
textarea{width:100%;padding:10px;border:1px solid #ccc;border-radius:10px}
.info{font-size:12px;color:#666}
</style>
</head>
<body>
<div class="wrap">
  <div class="info">Espace public â€” lecture seule, sans accÃ¨s Ã  lâ€™espace commerÃ§ant.</div>
  <div class="hero">
    <img id="pic" class="pic" alt="photo">
    <div>
      <h1 id="name">Nom</h1>
      <div id="headline" class="tag">Slogan / activitÃ©</div>
      <div id="addr" class="tag"></div>
    </div>
  </div>

  <div id="thanks" class="card" style="display:none"></div>
  <div id="desc" class="card" style="display:none"></div>
  <div class="btns" id="contacts"></div>

  <div class="card">
    <h3>Soutenir / don</h3>
    <div class="btns" id="donations"></div>
    <div class="btns">
      <input id="freeAmount" type="number" step="0.1" min="0" placeholder="Autre montant" style="padding:10px;border:1px solid #ccc;border-radius:10px">
      <a id="payFree" class="btn primary" target="_blank" rel="noopener">Payer</a>
    </div>
    <div style="color:#666;margin-top:6px">Paiement via Stripe/PayPal/Lydia. Aucune donnÃ©e bancaire n'est stockÃ©e ici.</div>
  </div>

  <div id="links" class="card" style="display:none">
    <h3>Liens</h3>
    <div id="linksList" class="grid"></div>
  </div>

  <div id="msg" class="card">
    <h3>Laisser un message au bÃ©nÃ©ficiaire</h3>
    <textarea id="messageBox" rows="3" placeholder="Un petit mot d'encouragement..."></textarea>
    <div class="btns">
      <a id="sendMsg" class="btn">Envoyer par eâ€‘mail</a>
    </div>
    <div class="tag">Astuce : envoyez votre message aprÃ¨s le don, ou dÃ¨s maintenant â€” merci ðŸ’š</div>
  </div>
</div>

<div id="notice" class="notice">ðŸ¥³ Merci pour votre don ! Votre soutien fait vivre le local ðŸ’š</div>

<script>
const CONFIG = {
  MODE: 'open', // 'open' or 'locked'
  LOCKED: {
    name: 'Boulangerie de Quartier',
    headline: 'Pain, cafÃ© & bons sourires',
    desc: 'Croissants au beurre, cafÃ© local, pain chaud.',
    address: '12 Rue des Pins, Laval',
    photo: '',
    pay: 'https://buy.stripe.com/test_6oE03kA9d3Yf4bGcMN',
    amounts: '2,5,10',
    thanks: 'Merci pour votre soutien !',
    contact: 'contact@exemple.fr',
    phone:'', wa:'', email:'', maps:'', site:'', ig:'', fb:'', yt:''
  },
  WHITELIST_PAY_HOSTS: ['buy.stripe.com','www.paypal.com','paypal.com','lydia-app.com']
};
function qs(n){ return new URLSearchParams(location.search).get(n) || '' }
function money(x){ try{ return new Intl.NumberFormat(undefined,{style:'currency',currency:'EUR'}).format(parseFloat(x)) } catch(e){ return x+'â‚¬' } }
function fromParams(){ return {
  name: qs('name')||'', headline: qs('headline')||'', desc: qs('desc')||'', address: qs('address')||'', photo: qs('photo')||'',
  pay: qs('pay')||'', amounts: (qs('amounts')||'2,5,10'),
  thanks: qs('thanks')||'', contact: qs('contact')||'', phone: qs('phone')||'', wa: qs('wa')||'', email: qs('email')||'', maps: qs('maps')||'', site: qs('site')||'',
  ig: qs('ig')||'', fb: qs('fb')||'', yt: qs('yt')||''
}; }
const data = (CONFIG.MODE==='locked') ? CONFIG.LOCKED : fromParams();

document.getElementById('name').textContent = data.name || 'BÃ©nÃ©ficiaire';
document.getElementById('headline').textContent = data.headline || '';
document.getElementById('addr').textContent = data.address || '';
const pic = document.getElementById('pic'); if(data.photo){ pic.src = data.photo } else { pic.style.display='none' }
if(data.desc){ const el = document.getElementById('desc'); el.style.display='block'; el.textContent = data.desc; }
if(data.thanks){ const el = document.getElementById('thanks'); el.style.display='block'; el.textContent = data.thanks; }

const contacts = document.getElementById('contacts');
function addBtn(txt, href, primary=false){ if(!href) return; const a=document.createElement('a'); a.className='btn'+(primary?' primary':''); a.textContent=txt; a.href=href; a.target='_blank'; a.rel='noopener'; contacts.appendChild(a); }
if(data.phone) addBtn('Appeler','tel:'+data.phone,true);
if(data.wa) addBtn('WhatsApp','https://wa.me/'+data.wa.replace(/^\+/,''));
if(data.email) addBtn('Email','mailto:'+data.email);
if(data.maps) addBtn('ItinÃ©raire', data.maps);
if(data.site) addBtn('Site', data.site);

// Social
const links = [];
[['IG','ig'],['FB','fb'],['YT','yt']].forEach(([label,key])=>{ const v=data[key]; if(v) links.push([label, v]); });
if(links.length){ document.getElementById('links').style.display='block'; const box=document.getElementById('linksList'); links.forEach(([label,href])=>{ const a=document.createElement('a'); a.className='btn'; a.textContent=label; a.href=href; a.target='_blank'; a.rel='noopener'; box.appendChild(a); }); }

// Donations (with pay host whitelist)
const dons=document.getElementById('donations');
function isAllowedPay(url){ try{ const h=new URL(url, location.href).host.toLowerCase(); return CONFIG.WHITELIST_PAY_HOSTS.includes(h); }catch(e){ return false; } }
const pay=data.pay; const amounts=(data.amounts||'2,5,10').split(',').map(x=>x.trim()).filter(Boolean);
function quick(amount){
  const a=document.createElement('a'); a.className='btn'; a.textContent=money(amount);
  let url='#';
  if(pay && isAllowedPay(pay)){ const u=new URL(pay, location.href); if(!u.searchParams.has('amount')) u.searchParams.append('amount', amount); if(!u.searchParams.has('return_url')) u.searchParams.append('return_url', location.origin + location.pathname + '?paid=true&name='+encodeURIComponent(data.name||'')); url=u.toString(); }
  a.href=url; a.target='_blank'; a.rel='noopener'; dons.appendChild(a);
}
amounts.forEach(a=>quick(a));
const freeAmt=document.getElementById('freeAmount'); const payFree=document.getElementById('payFree');
function updateFree(){ let url='#'; const v=freeAmt.value; if(v && !isNaN(parseFloat(v)) && pay && isAllowedPay(pay)){ const u=new URL(pay, location.href); if(!u.searchParams.has('amount')) u.searchParams.append('amount', v); if(!u.searchParams.has('return_url')) u.searchParams.append('return_url', location.origin + location.pathname + '?paid=true&name='+encodeURIComponent(data.name||'')); url=u.toString(); } payFree.href=url; }
freeAmt.addEventListener('input', updateFree); updateFree();

// Thanks toast
function getQ(n){ return new URLSearchParams(location.search).get(n) || '' }
if(getQ('paid') === 'true'){ const n=document.getElementById('notice'); n.classList.add('show'); setTimeout(()=>n.classList.remove('show'), 3500); }

// Message email
document.getElementById('sendMsg').addEventListener('click',(e)=>{
  e.preventDefault();
  const msg = (document.getElementById('messageBox').value || '');
  const to = (data.contact || '');
  if(!to){ alert('Aucune adresse de contact dÃ©finie.'); return; }
  const subject = 'Message via QRLocal â€” ' + (data.name||'');
  const body = msg || 'Bonjour !';
  window.location.href = 'mailto:'+to+'?subject='+encodeURIComponent(subject)+'&body='+encodeURIComponent(body);
});
</script>
</body>
</html>